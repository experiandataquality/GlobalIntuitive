/*! contact-data-services.js | https://github.com/TeamArachne/contactdataservices | Apache-2.0
*   Team Arachne, Experian Data Quality | team.arachne@gmail.com */
!function(a,b,c){"use strict";var d=a.ContactDataServices=a.ContactDataServices||{};d.selectors={main:"#contact-data-services-container",map:"#contact-data-services-map",controls:"#contact-data-services-controls"},d.mapEndpoint="http://maps.googleapis.com/maps/api/js?sensor=false&callback=ContactDataServices.loadMap";var e=function(b,c,d,e,f){if(b="object"==typeof b?b:{},c="function"==typeof c?c:function(){},d="function"==typeof d?d:function(){},e="function"==typeof e?e:function(){},f="object"==typeof f?f:a,!f.navigator.geolocation)return e(),!1;var g=setTimeout(c,500);f.navigator.geolocation.getCurrentPosition(function(a){return b.lat=a.coords.latitude,b.lng=a.coords.longitude,b.lat&&b.lng?(d(),clearTimeout(g),!0):void 0},function(){return e(),clearTimeout(g),!1})},f=function(a){var c={mapTypeControl:!1,streetViewControl:!1,scaleControl:!1,zoomControl:!1,panControl:!1,scrollwheel:!1,keyboardShortcuts:!1,draggable:!1,zoom:14,mapTypeId:google.maps.MapTypeId.ROADMAP},d=new google.maps.Map(b.querySelector(a),c);return d.pan=function(a){if("number"!=typeof a.lat||"number"!=typeof a.lng)return!1;var b=new google.maps.LatLng(a.lat,a.lng);return d.panTo(b),!0},d};d.getGeolocation=function(a,b,c){d.coords={};new e(d.coords,a,b,c)},d.getGeolocation(function(){console.log("waiting for geolocation permission...")},function(){d.insertMap(d.mapEndpoint)},function(){console.log("geolocation was blocked or unavailable")}),d.insertMap=function(a){if("string"!=typeof a)return!1;d.map=null;var c=(d.coords||{},b.createElement("script"));return c.src=a,c.async=!0,b.getElementsByTagName("head")[0].appendChild(c),!0},d.loadMap=function(){var a=d.selectors.map;d.map=new f(a),d.map.pan(d.coords)},d.urls={endpoint:"http://int-test-01/capture/address/v2/search",construct:{address:{search:function(a){var b=d.urls.endpoint;return b+="?query="+a.currentSearchTerm,b+="&country="+a.currentCountryCode,b+="&take="+(a.maxSize||a.picklist.maxSize),b=d.urls.addToken(b,a.token)},format:function(a,b){return a=d.urls.addToken(a,b.token)}}},addToken:function(a,b){return a+"&auth-token="+b}},d.eventFactory=function(){var a={};return a.collection={},a.on=function(b,c){a.collection[b]=a.collection[b]||[],a.collection[b].push(c)},a.trigger=function(b,c){if(a.collection[b])for(var d=0;d<a.collection[b].length;d++){for(var e=[c],f=2;f<arguments.length;f++)e.push(arguments[f]);a.collection[b][d].apply(a.collection,e)}},a},d.defaults={input:{placeholder:"Start typing an address"},formattedAddress:{headingType:"h3",headingText:"Formatted address"},editAddressText:"Edit address",useAddressEnteredText:"<em>Use address entered</em>"},d.address=function(a){var e=a||{};return e.enabled=!0,e.lastSearchTerm="",e.currentSearchTerm="",e.lastCountryCode="",e.currentCountryCode="",e.currentSearchUrl="",e.currentFormatUrl="",e.placeholder=e.placeholder||d.defaults.input.placeholder,e.editAddressText=e.editAddressText||d.defaults.editAddressText,e.formattedAddress=e.formattedAddress||d.defaults.formattedAddress,e.events=new d.eventFactory,e.init=function(){e.token||(console.log("Please provide a token for ContactDataServices."),e.enabled=!1),e.setCountryList(),e.elements.input&&(e.input=e.elements.input,e.input.addEventListener("keyup",e.search),e.input.setAttribute("placeholder",e.placeholder),e.input.parentNode.setAttribute("autocomplete","off"))},e.search=function(){if(e.currentSearchTerm=e.input.value,e.currentCountryCode=e.countryList.value,e.canSearch()){var a=new d.requestFactory;e.request=a,e.request.currentRequest&&e.request.currentRequest.abort();var b=d.urls.construct.address.search(e);e.lastSearchTerm=e.currentSearchTerm,e.result.hide(),e.searchSpinner.hide(),e.searchSpinner.show(),e.request.get(b,e.picklist.show)}else e.lastSearchTerm!==e.currentSearchTerm&&e.picklist.hide()},e.setCountryList=function(){e.countryList=e.elements.countryList,e.countryList||e.createCountryDropdown()},e.canSearch=function(){return e.enabled&&""!==e.currentSearchTerm&&e.lastSearchTerm!==e.currentSearchTerm&&""!==e.countryList.value},e.createCountryDropdown=function(){},e.format=function(a){e.events.trigger("formatting-search",a),e.searchSpinner.hide(),e.currentFormatUrl=d.urls.construct.address.format(a,e),e.currentFormatUrl.indexOf("https://api.edq.com")>-1&&(e.currentFormatUrl=e.currentFormatUrl.replace("https://api.edq.com","http://int-test-01")),e.request.get(e.currentFormatUrl,e.result.show)},e.picklist={size:0,maxSize:25,show:function(a){e.picklist.items=a.results,e.picklist.size=e.picklist.items.length,e.picklist.container=e.picklist.container||e.picklist.createList(),e.picklist.container.innerHTML="",e.searchSpinner.hide(),e.picklist.createUseAddressEntered(),e.picklist.items.length>0&&e.picklist.items.forEach(function(a){var b=e.picklist.createListItem(a);e.picklist.container.appendChild(b),e.picklist.listen(b)})},hide:function(){e.picklist.container&&(e.input.parentNode.removeChild(e.picklist.container),e.picklist.container=c)},createUseAddressEntered:function(){var a={suggestion:d.defaults.useAddressEnteredText,format:""},b=e.picklist.createListItem(a);e.picklist.container.appendChild(b),b.addEventListener("click",e.picklist.useAddressEntered)},useAddressEntered:function(){var a={address:[{content:e.currentSearchTerm}]};e.result.show(a)},createList:function(){var a=b.createElement("div");return a.classList.add("address-picklist"),e.input.parentNode.insertBefore(a,e.input.nextSibling),a},createListItem:function(a){var c=b.createElement("div");return c.innerHTML=e.picklist.addMatchingEmphasis(a),c.setAttribute("format",a.format),c},addMatchingEmphasis:function(a){for(var b=a.matched||[],c=a.suggestion,d=0;d<b.length;d++){var e="<b>"+c.substring(b[d][0],b[d][1])+"</b>";c=c.substring(0,b[d][0])+e+c.substring(b[d][1])}return c},listen:function(a){a.addEventListener("click",e.picklist.pick.bind(null,a))},pick:function(a){e.format(a.getAttribute("format"))}},e.result={show:function(a){if(e.searchSpinner.hide(),e.picklist.hide(),a.address.length>0){e.events.trigger("formatted-address",a),e.result.formattedAddress=e.elements.formattedAddress||e.result.createFormattedAddressContainer();for(var b=[],c=0;c<a.address.length;c++){var d=a.address[c];for(var f in d)if(d.hasOwnProperty(f)){var g=e.result.createAddressLine.row(d[f]);e.result.formattedAddress.appendChild(g),b.push(e.result.createAddressLine.input(f,d[f]))}}e.result.renderInputList(b),e.result.createEditAddressLink()}},hide:function(){e.result.formattedAddress&&(e.input.parentNode.removeChild(e.result.formattedAddress),e.result.formattedAddress=c)},createFormattedAddressContainer:function(){var a=b.createElement("div");if(a.classList.add("formatted-address"),e.formattedAddress.heading!==!1){var c=b.createElement(e.formattedAddress.headingType);c.innerHTML=e.formattedAddress.headingText,a.appendChild(c)}return e.input.parentNode.insertBefore(a,e.input.nextSibling),a},createAddressLine:{input:function(a,c){var d=b.createElement("div");d.classList.add("hidden"),d.classList.add("address-line-input");var e=b.createElement("label");e.innerHTML=a,d.appendChild(e);var f=b.createElement("input");return f.setAttribute("type","text"),f.setAttribute("name",a),f.setAttribute("value",c),d.appendChild(f),d},row:function(a){var c=b.createElement("div");return c.classList.add("toggle"),c.innerHTML=a,c}},createEditAddressLink:function(){var a=b.createElement("a");a.setAttribute("href","#"),a.classList.add("edit-address-link"),a.innerHTML=e.editAddressText,e.result.formattedAddress.appendChild(a),a.addEventListener("click",e.result.editAddressManually)},editAddressManually:function(a){a.preventDefault(),e.result.formattedAddress.querySelector(".edit-address-link").classList.add("hidden");for(var b=e.result.formattedAddress.querySelectorAll(".toggle"),c=0;c<b.length;c++)b[c].classList.add("hidden");for(var d=e.result.formattedAddress.querySelectorAll(".address-line-input"),f=0;f<d.length;f++)d[f].classList.remove("hidden")},renderInputList:function(a){if(a.length>0)for(var b=0;b<a.length;b++)e.result.formattedAddress.appendChild(a[b])}},e.searchSpinner={show:function(){var a=b.createElement("div");a.classList.add("loader"),a.classList.add("loader-inline");var c=b.createElement("div");c.classList.add("spinner"),a.appendChild(c),e.input.parentNode.insertBefore(a,e.input.nextSibling)},hide:function(){var a=e.input.parentNode.querySelector(".loader-inline");a&&e.input.parentNode.removeChild(a)}},e.init(),e},d.requestFactory=function(){var a={currentRequest:null,get:function(b,c){a.currentRequest=new XMLHttpRequest,a.currentRequest.open("GET",b,!0),a.currentRequest.timeout=5e3,a.currentRequest.onload=function(){if(a.currentRequest.status>=200&&a.currentRequest.status<400){var b=JSON.parse(a.currentRequest.responseText);console.log(b),c(b)}},a.currentRequest.onerror=function(){},a.currentRequest.ontimeout=function(){},a.currentRequest.send()}};return a}}(window,window.document);